# 8. 분산 이메일 서비스
- 지메일, 아웃룩과 같은 대규모 이메일 서비스 설계

## 8.1 문제 이해 및 설계 범위 확정
- 오랜 세월 이메일 서비스는 복잡성과 규모 면에서 크게 달라짐 -> 45분동안 설계하기 힘듬
##### 비기능 요구사항
- 안전성: 이메일 데이터는 소실되어서는 안됨
- 가용성: 이메일과 사용자 데이터를 여러 노드에 복제하여 가용성 확보
- 확장성: 사용자 수가 늘어나도 감당 가능 및 시스템 저하 방지
- 유연성과 확장성: 새 컴포넌트를 쉽게 기능 추가 및 성능 개선할 수 있는 유연한 확장 가능 -> POP나 IMAP 같은 기존 이메일 프로토콜은 기능이 매우 제한적임

##### 개략적 규모 추정
- 10억 명의 사용자
- 한 사람이 하루에 보내는 평균 이메일 수 10건 가정 -> QPS = 10<sup>9</sup> x 10 / 10<sup>5</sup> = 100,000
- 한 사람이 하루에 수신하는 이메일 수는 평균 40건 가정, 이메일 하나의 메타데이터는 평균 50KB(첨부파일 포함x)
- 1년간 메타데이터를 유지하기 위한 스토리지 요구사항은 730pb
  - 메타데이터를 데이터베이스에 저장한다고 가정 
  - 10억명 사용자 x 하루 40건 이메일 x 365일 x 50kb = 730pb
- 첨부 파일을 포함하는 이메일의 비율은 20%이며, 첨부 파일의 평균 크기는 500kb라고 가정
- 1년간 첨부 파일을 보관하는 데 필요한 저장 용량은 1,460PB
  - 10억 명 사용자 x 하루 40개 이메일 x 365일 x 20% x 500kb

## 8.2 개략적 설계안 제시 및 동의 구하기
- 이메일 서버에 대해 알아야 할 몇가지 기본적인 사항과 더불어 이메일 서버 흐름 논의
##### 이메일 101
- 이메일을 주고 받는 프로토콜 존재
  - SMTP(Simple Mail Transfer Protocol)
    - 이메일을 한 서버에서 다른 서버로 보내는 표준 프로토콜
  - POP(Post Office Protocol)
    - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드하기 위해 사용하는 표준 프로토콜
    - 일단 단말로 다운로드 된 이메일은 서버에서 삭제됨 -> 한대의 단말에서만 이메일을 읽을 수 있음
    - 클라이언트는 일부 이메일만 읽을 수 없음 -> 용량이 큰 첨부 파일이 붙은 이메일은 읽으려면 오래 걸림
  - IMAP(Internet Mail Access Protocol)
    - 이메일을 수신하는 또 다른 표준의 프로토콜
    - 클릭하지 않으면 메시지는 다운로드 되지 않으며, 메일서버에서도 지워지지도 않음 -> 여러 단말에서 이메일을 읽을 수 있음
    - 인터넷 속도가 느려도 잘 동작하며, 실제로 열기 전에는 헤더만 다운로드함
  - HTTPS
    - 메일 전송 프로토콜은 아니지만 웹 기반 이메일 시스템의 메일함 접속에 이용 가능
    - 아웃룩은 액티브싱크라는 HTTPS 기반 자체 프로톸콜을 통해 모바일 단말과의 통신을 처리
- 도메인 이름 서비스(DNS)<br>
  <img src="269 8.2.png" alt="drawing" width="300px"/><br>
  - DNS 서버는 수신자 도메인의 메일 교환기 레코드(Mail Exchange,MX) 검색에 이용
  - 우선 순위 값은 선호도를 나타내며, 그 값이 낮으면 우선순위가 높아서 선호
    - 위에 그림에서 gmail-smtp-in.l.google.com. 이 우선순위가 가장 높으므로(5) 최우선
  - 우선 순위 높은 서버에 접속하여 메시지를 전송 시도 -> 실패 시, 다음 순위 서버 접속
- 첨부파일
  - 이메일 메시지와 같이 전송되며, base64로 인코딩되어 전송
  - 일반적으로 크기 제한 존재
##### 전통적 메일 서버
- 보통 서버 한대로 운용, 사용자가 많지 않을때는 잘 동작하는 시스템
- 전통적 메일 서버 아키텍처<br>
<img src="270 8.3.png" alt="drawing" width="500px"/><br>
  - ① 앨리스가 아웃룩 메일서버로 SMTP 프로토콜을 통해 메일 발송
  - ② 아웃룻 메일서버는 DNS 질의를 통해 수신사 SMTP 서버 주소를 찾고, 수신사 지메일 SMTP 서버로 메일 발송(프로토콜 SMTP)
  - ③ 지메일 서버는 이메일을 저장하고 수신자인 밥이 읽어 갈 수 있도록 처리
  - ④ 밥이 지메일에 로그인하면 지메일 클라이언트는 IMAP/POP 서버를 통해 새 메일을 수신
- 저장소<br>
<img src="271 8.4.png" alt="drawing" width="500px"/><br>
  - 이메일을 파일 시스템의 디렉터리에 저장 -> 각각의 이메일은 고유한 이름을 가진 별도 파일로 보관, 각 사용자의 설정 데이터와 메일함은 사용자 디렉터리에 보관
  - 사용자가 많지 않을때는 잘 동작하지만, 수십억 개의 이메일을 검색하고 백업하는 목적으로 활용 곤란
    - 파일 구조가 복잡해지고 디스크 I/O 병목 발생
    - 이메일을 서버의 파일 시스템에 보관하므로 가용성과 안전성 요구사항 미충족
- POP, IMAP, SMTP 같은 이메일 프로토콜은 멀티미디어, 메일 타래, 검색 등 미지원 
##### 분산 메일 서버
- 현대적 사용 패턴을 지원하고 확장성과 안전성 문제 해결
- 이메일 API
  - 
- 분산 이메일 서버 아키텍처
  - 
- 이메일 발송 및 수신 흐름
  - 
